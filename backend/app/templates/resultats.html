<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Votre lettre est prête - Je me défends</title>
    <meta
      name="description"
      content="Choisissez comment recevoir votre lettre de mise en demeure : version gratuite, PDF professionnel ou envoi direct."
    />

    <!-- CSS spécifique -->
    <link rel="stylesheet" href="/static/css/resultats.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              "fade-in": "fadeIn 0.8s ease-out forwards",
              "slide-up": "slideUp 1s ease-out forwards",
              "bounce-subtle": "bounceSubtle 3s ease-in-out infinite",
              "pulse-soft": "pulseSoft 2s ease-in-out infinite",
              shine: "shine 2s linear infinite",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(30px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              slideUp: {
                "0%": { opacity: "0", transform: "translateY(50px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
              bounceSubtle: {
                "0%,100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
              pulseSoft: {
                "0%,100%": { transform: "scale(1)" },
                "50%": { transform: "scale(1.05)" },
              },
              shine: { "0%": { left: "-100%" }, "100%": { left: "100%" } },
            },
          },
        },
      };
    </script>

    <style>
      /* Seuls les effets shine restent ici car ils sont liés aux animations Tailwind */
      .shine-effect {
        position: relative;
        overflow: hidden;
      }
      .shine-effect::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        transition: left 0.6s ease;
      }
      .shine-effect:hover::before {
        left: 100%;
      }
    </style>
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100"
  >
    <!-- Nav compacte (aligné au modèle du test) -->
    <nav
      class="bg-white/80 backdrop-blur-md border-b border-white/20 sticky top-0 z-50"
    >
      <div class="max-w-6xl mx-auto px-4 py-1.5">
        <div class="flex items-center justify-between">
          <a
            href="/"
            class="flex items-center gap-2"
            aria-label="Je me défends – Accueil"
          >
            <img
              src="/static/images/logo_jemedefends.svg"
              alt="Je me défends – logo"
              class="w-36 md:w-40"
              width="160"
              height="40"
            />
          </a>
        </div>
      </div>
    </nav>

    <!-- Décor -->
    <div class="fixed inset-0 opacity-30 pointer-events-none">
      <div
        class="absolute top-20 left-10 w-72 h-72 bg-emerald-500/20 rounded-full blur-3xl animate-pulse-soft"
      ></div>
      <div
        class="absolute bottom-20 right-10 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl animate-pulse-soft"
        style="animation-delay: -3s"
      ></div>
    </div>

    <!-- Container -->
    <div class="max-w-7xl mx-auto px-4 py-6 md:py-8">
      <!-- Header -->
      <div class="text-center mb-6 md:mb-8 motion-safe:animate-fade-up-sm">
        <div class="relative inline-block">
          <div class="relative flex items-center justify-center gap-3 mb-2">
            <div
              class="p-2.5 bg-gradient-to-br from-emerald-600 to-green-600 rounded-xl shadow-md"
            >
              <svg
                class="w-7 h-7 text-white transform rotate-3"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h1
              class="text-2xl md:text-4xl font-extrabold text-gray-900 leading-tight"
            >
              Votre lettre est prête !
            </h1>
          </div>
        </div>
        <p class="text-base md:text-lg text-gray-700 font-semibold">
          Choisissez comment vous souhaitez
          <span class="text-emerald-600 font-bold"
            >recevoir votre mise en demeure</span
          >
        </p>
        <p class="text-sm md:text-base text-gray-500 font-medium">
          Optez pour la solution qui vous convient le mieux
        </p>
      </div>

      <!-- Messages -->
      <div id="messages"></div>

      <!-- Plans -->
      <div class="pricing-container mb-12">
        <div class="grid lg:grid-cols-3 gap-8">
          <!-- Gratuit -->
          <div
            class="plan-card bg-white/60 rounded-3xl p-8 border-2 border-gray-200 relative animate-slide-up"
            style="animation-delay: 0.3s"
          >
            <div class="absolute top-4 right-4">
              <span
                class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium"
                >Basique</span
              >
            </div>
            <div class="text-center mb-6">
              <div
                class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4"
              >
                <svg
                  class="w-8 h-8 text-gray-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 01-1.447.894L12 15.382l-2.553 1.512A1 1 0 018 16V4z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-gray-900 mb-2">
                Version gratuite
              </h3>
              <div class="text-4xl font-black text-gray-700 mb-2">0€</div>
              <p class="text-gray-600 text-sm">Lettre à compléter</p>
            </div>
            <ul class="space-y-3 mb-8">
              <li class="flex items-center gap-3 text-gray-700">
                <svg
                  class="w-5 h-5 text-gray-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
                Contenu juridique complet
              </li>
              <li class="flex items-center gap-3 text-gray-700">
                <svg
                  class="w-5 h-5 text-gray-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  />
                </svg>
                Adapté à vos informations
              </li>
              <li class="flex items-center gap-3 text-gray-500">
                <svg
                  class="w-5 h-5 text-red-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span>Texte à formater</span>
              </li>
              <li class="flex items-center gap-3 text-gray-500">
                <svg
                  class="w-5 h-5 text-red-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span>Rendu non-professionnel</span>
              </li>
              <li class="flex items-center gap-3 text-gray-500">
                <svg
                  class="w-5 h-5 text-red-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span>Pas de suppport</span>
              </li>
            </ul>
            <!-- Bouton pour la version gratuite -->
            <button
              type="button"
              onclick="showBasicModal()"
              class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 px-6 rounded-2xl transition-all duration-300 border-2 border-gray-300 flex items-center justify-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              Voir la lettre gratuite
            </button>
            <p class="text-xs text-gray-500 mt-3 text-center">
              💡 Contenu juridique complet avec bouton "Copier"
            </p>
          </div>

          <!-- Premium (PDF) -->
          <div
            class="plan-card bg-gradient-to-b from-blue-50 to-indigo-100 rounded-3xl p-8 border-4 border-blue-400 relative animate-slide-up"
            style="animation-delay: 0.4s"
          >
            <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
              <span
                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg animate-bounce-subtle whitespace-nowrap"
              >
                ⭐ RECOMMANDÉ
              </span>
            </div>
            <div class="text-center mb-6">
              <div
                class="w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"
              >
                <svg
                  class="w-8 h-8 text-white"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                  />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-blue-900 mb-2">
                PDF professionnel
              </h3>
              <div class="text-4xl font-black text-blue-700 mb-1">2,99€</div>
              <p class="text-blue-600 text-sm font-medium">
                Version mise en page
              </p>
            </div>
            <ul class="space-y-3 mb-8 text-blue-800">
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                ><strong>Mise en page professionnelle</strong>
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                ><strong>Support gratuit</strong>
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Prêt à imprimer & envoyer
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Guide d'envoi inclus
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Téléchargement instantané
              </li>
            </ul>
            <button
              id="btn-premium-pdf"
              class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl shine-effect"
            >
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
                Obtenir le PDF professionnel
              </span>
            </button>
            <p class="text-xs text-blue-700 mt-3 text-center font-medium">
              ✨ Imprimez et envoyez immédiatement
            </p>
          </div>

          <!-- Premium Plus (postal) -->
          <div
            class="plan-card bg-gradient-to-b from-purple-50 to-pink-100 rounded-3xl p-8 border-2 border-purple-300 relative animate-slide-up"
            style="animation-delay: 0.5s"
          >
            <div class="absolute top-4 right-4">
              <span
                class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 py-1 rounded-full text-sm font-medium"
                >Premium</span
              >
            </div>
            <div class="text-center mb-6">
              <div
                class="w-16 h-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"
              >
                <svg
                  class="w-8 h-8 text-white"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                  />
                  <path
                    d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                  />
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-purple-900 mb-2">
                Envoi automatique
              </h3>
              <div class="text-4xl font-black text-purple-700 mb-2">12,99€</div>
              <p class="text-purple-600 text-sm">Service complet</p>
            </div>
            <ul class="space-y-3 mb-8 text-purple-800">
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-purple-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                ><strong>Tout le service PDF</strong>
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-purple-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                ><strong>Envoi courrier recommandé</strong>
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-purple-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Accusé de réception inclus
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-purple-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Copie par email pour vous
              </li>
              <li class="flex items-center gap-3">
                <svg
                  class="w-5 h-5 text-purple-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  /></svg
                >Suivi de livraison
              </li>
            </ul>
            <button
              id="btn-postal"
              class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl shine-effect"
            >
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                  />
                  <path
                    d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                  />
                </svg>
                Envoi automatique
              </span>
            </button>
            <p class="text-xs text-purple-700 mt-3 text-center">
              📬 Envoyé sous 24h, vous ne faites rien !
            </p>
          </div>
        </div>
      </div>

      <!-- Garanties -->
      <div
        class="bg-gradient-to-r from-gray-50 to-slate-100 rounded-3xl p-8 border border-gray-200 text-center animate-slide-up"
        style="animation-delay: 0.8s"
      >
        <h2 class="text-2xl font-bold text-gray-900 mb-6">🔒 Nos garanties</h2>
        <div class="grid md:grid-cols-4 gap-6">
          <div class="text-center">
            <div
              class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h3 class="font-bold text-gray-900 text-sm">Paiement sécurisé</h3>
            <p class="text-gray-600 text-xs">Stripe & PayPal</p>
          </div>
          <div class="text-center">
            <div
              class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                <path
                  fill-rule="evenodd"
                  d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h3 class="font-bold text-gray-900 text-sm">
              Satisfaction garantie
            </h3>
            <p class="text-gray-600 text-xs">Remboursé si non satisfait</p>
          </div>
          <div class="text-center">
            <div
              class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h3 class="font-bold text-gray-900 text-sm">Support inclus</h3>
            <p class="text-gray-600 text-xs">Assistance par email</p>
          </div>
          <div class="text-center">
            <div
              class="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <h3 class="font-bold text-gray-900 text-sm">Conformité légale</h3>
            <p class="text-gray-600 text-xs">Validé par des juristes</p>
          </div>
        </div>
        <p class="text-gray-600 text-sm mt-6">
          🏛️ Basé sur le Code de la consommation français • Valeur juridique
          reconnue
        </p>
      </div>
    </div>

    <!-- Modale version basic gratuite -->
    <div id="basic-modal" class="modal">
      <div class="modal-content max-w-4xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">
            📄 Version gratuite - Lettre de mise en demeure
          </h3>
          <button class="close-btn" onclick="hideBasicModal()">×</button>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <div class="flex items-start gap-3">
            <svg
              class="w-5 h-5 text-yellow-600 mt-0.5"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <div>
              <p class="text-yellow-800 font-medium">Version gratuite</p>
              <p class="text-yellow-700 text-sm">
                Cette lettre doit être complétée, imprimée et envoyée par vos
                soins. Pour une version PDF professionnelle avec mise en page,
                optez pour nos services premium.
              </p>
            </div>
          </div>
        </div>

        <!-- Contenu de la lettre -->
        <div
          class="bg-white border border-gray-200 rounded-lg p-6 mb-4 max-h-96 overflow-y-auto"
        >
          <div id="basic-letter-content" class="prose prose-sm max-w-none">
            <!-- Le contenu sera injecté ici -->
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 justify-end">
          <button
            type="button"
            onclick="hideBasicModal()"
            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-colors"
          >
            Fermer
          </button>
          <button
            type="button"
            onclick="copyBasicText()"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              />
            </svg>
            Copier le texte
          </button>
        </div>
      </div>
    </div>

    <!-- Modale PDF (paiement + signature + aperçu lié à la signature) -->
    <div id="pdf-modal" class="modal">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900">
            📄 Finaliser votre PDF
          </h3>
          <button class="close-btn" onclick="hidePdfModal()">×</button>
        </div>

        <div class="mb-4">
          <label class="block font-semibold text-gray-700 mb-1"
            >Email pour recevoir le PDF
            <span class="text-red-500">*</span></label
          >
          <input
            type="email"
            id="pdf-email"
            class="w-full border-2 border-gray-200 rounded-md p-3 focus:border-blue-500 outline-none"
            placeholder="votre@email.com"
          />
          <p class="text-sm text-gray-500 mt-1">
            Nous vous enverrons le PDF par email une fois généré
          </p>
        </div>

        <div class="mb-4">
          <label class="block font-semibold text-gray-700 mb-1"
            >Votre signature <span class="text-red-500">*</span></label
          >
          <canvas id="signature-canvas" class="signature-canvas"></canvas>
          <div class="mt-2 flex gap-2">
            <button
              type="button"
              id="clear-signature-btn"
              class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition-colors"
            >
              Effacer
            </button>
          </div>
        </div>

        <!-- Génère un aperçu filigrané lié à la signature -->
        <button
          id="preview-btn"
          onclick="generatePreview()"
          class="w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg mb-4 flex items-center justify-center gap-2"
          disabled
        >
          <span id="preview-btn-text"
            >Télécharger un aperçu (PDF filigrané)</span
          >
          <div id="preview-loading" class="loading"></div>
        </button>

        <div
          class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4"
        >
          <div class="flex items-center justify-between mb-1">
            <span class="font-semibold text-blue-900">PDF professionnel</span>
            <span class="text-2xl font-black text-blue-900">2,99€</span>
          </div>
          <p class="text-sm text-blue-700">
            Paiement sécurisé • Livraison immédiate par email
          </p>
        </div>

        <div class="flex gap-3">
          <button
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg"
            onclick="hidePdfModal()"
          >
            Annuler
          </button>
          <button
            class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
            onclick="generatePdf()"
          >
            <span id="pdf-btn-text">Générer et payer</span>
            <div id="pdf-loading" class="loading"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- Modale Postal -->
    <div id="postal-modal" class="modal">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900">
            📮 Service d'envoi postal
          </h3>
          <button class="close-btn" onclick="hidePostalModal()">×</button>
        </div>

        <div class="mb-4">
          <label class="block font-semibold text-gray-700 mb-1"
            >Email pour le suivi <span class="text-red-500">*</span></label
          >
          <input
            type="email"
            id="postal-email"
            class="w-full border-2 border-gray-200 rounded-md p-3 focus:border-blue-500 outline-none"
            placeholder="votre@email.com"
          />
          <p class="text-sm text-gray-500 mt-1">
            Nous vous tiendrons informé de l'envoi et de la livraison
          </p>
        </div>

        <div class="mb-4">
          <label class="block font-semibold text-gray-700 mb-1"
            >Votre signature <span class="text-red-500">*</span></label
          >
          <div class="signature-container">
            <canvas
              id="signature-canvas-postal"
              class="signature-canvas"
            ></canvas>
            <div class="mt-2 flex gap-2">
              <button
                type="button"
                id="clear-signature-postal-btn"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded transition-colors"
              >
                Effacer
              </button>
            </div>
          </div>
        </div>

        <button
          id="preview-btn-postal"
          onclick="generatePreviewPostal()"
          class="w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg mb-4 flex items-center justify-center gap-2"
          disabled
        >
          <span id="preview-btn-postal-text"
            >Télécharger un aperçu (PDF filigrané)</span
          >
          <div id="preview-postal-loading" class="loading"></div>
        </button>

        <div
          class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 mb-4"
        >
          <div class="font-semibold text-purple-900 mb-2">
            📦 Ce qui est inclus :
          </div>
          <ul class="text-purple-800 text-sm space-y-1">
            <li>✓ Impression professionnelle</li>
            <li>✓ Envoi en recommandé avec AR</li>
            <li>✓ Suivi en temps réel</li>
            <li>✓ Accusé de réception numérisé</li>
          </ul>
        </div>

        <div
          class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 mb-4"
        >
          <div class="flex items-center justify-between mb-1">
            <span class="font-semibold text-purple-900">Service complet</span>
            <span class="text-2xl font-black text-purple-900">12,99€</span>
          </div>
          <p class="text-sm text-purple-800">
            Paiement sécurisé • Envoi sous 24h ouvrées
          </p>
        </div>

        <div class="flex gap-3">
          <button
            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg"
            onclick="hidePostalModal()"
          >
            Annuler
          </button>
          <button
            class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"
            onclick="generatePostal()"
          >
            <span id="postal-btn-text">Commander l'envoi</span>
            <div id="postal-loading" class="loading"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="/static/js/resultats.js"></script>

    <script>
      // Script additionnel pour les corrections demandées
      document.addEventListener("DOMContentLoaded", function () {
        // 1. Récupération de l'email du formulaire depuis sessionStorage ou API
        async function populateEmailFromFormData() {
          try {
            // Vérifier d'abord le sessionStorage (cas où les données y seraient)
            let buyerEmail = null;

            // Source 1: formData directement
            const formData = sessionStorage.getItem("formData");
            if (formData) {
              const data = JSON.parse(formData);
              buyerEmail = data.buyer_email || data.email || data.buyerEmail;
              console.log("🔍 FormData trouvé:", data);
            }

            // Source 2: Données de lettre si pas d'email dans formData
            if (!buyerEmail) {
              const letterData = sessionStorage.getItem("letterData");
              if (letterData) {
                const data = JSON.parse(letterData);
                buyerEmail = data.buyer_email || data.email || data.buyerEmail;
                console.log("🔍 LetterData trouvé:", data);
              }
            }

            // Source 3: Récupération via API avec le letterId
            if (!buyerEmail) {
              const letterId = sessionStorage.getItem("currentLetterId");
              if (letterId) {
                console.log(
                  "🔍 Tentative de récupération via API avec letterId:",
                  letterId,
                );
                try {
                  const response = await fetch(`/api/v1/letters/${letterId}`);
                  if (response.ok) {
                    const letterData = await response.json();
                    buyerEmail =
                      letterData.buyer_email || letterData.buyer?.email;
                    console.log(
                      "🔍 Données lettre récupérées via API:",
                      letterData,
                    );
                  } else {
                    console.warn("⚠️ Erreur API:", response.status);
                  }
                } catch (apiError) {
                  console.warn("⚠️ Erreur lors de l'appel API:", apiError);
                }
              }
            }

            // Debug: Afficher tout le sessionStorage
            console.log("🔍 Contenu complet du sessionStorage:", {
              ...sessionStorage,
            });

            if (buyerEmail && buyerEmail.includes("@")) {
              // Remplir les champs email des modales
              const pdfEmailInput = document.getElementById("pdf-email");
              const postalEmailInput = document.getElementById("postal-email");

              if (pdfEmailInput && !pdfEmailInput.value) {
                pdfEmailInput.value = buyerEmail;
                console.log("✅ Email PDF rempli:", buyerEmail);
              }

              if (postalEmailInput && !postalEmailInput.value) {
                postalEmailInput.value = buyerEmail;
                console.log("✅ Email postal rempli:", buyerEmail);
              }

              return true;
            } else {
              console.warn(
                "⚠️ Aucun email valide trouvé dans le sessionStorage ou via API",
              );
              return false;
            }
          } catch (e) {
            console.error("❌ Erreur lors de la récupération de l'email:", e);
            return false;
          }
        }

        // 2. Configuration des boutons effacer signature
        function setupClearButtons() {
          // Bouton effacer pour la signature PDF
          const clearSignatureBtn = document.getElementById(
            "clear-signature-btn",
          );
          if (clearSignatureBtn) {
            clearSignatureBtn.addEventListener("click", function (e) {
              e.preventDefault();
              const canvas = document.getElementById("signature-canvas");
              if (canvas) {
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Désactiver le bouton d'aperçu
                const previewBtn = document.getElementById("preview-btn");
                if (previewBtn) {
                  previewBtn.disabled = true;
                }

                console.log("🧹 Signature PDF effacée");
              }
            });
          }

          // Bouton effacer pour la signature postale
          const clearSignaturePostalBtn = document.getElementById(
            "clear-signature-postal-btn",
          );
          if (clearSignaturePostalBtn) {
            clearSignaturePostalBtn.addEventListener("click", function (e) {
              e.preventDefault();
              const canvas = document.getElementById("signature-canvas-postal");
              if (canvas) {
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Désactiver le bouton d'aperçu postal
                const previewBtn =
                  document.getElementById("preview-btn-postal");
                if (previewBtn) {
                  previewBtn.disabled = true;
                }

                console.log("🧹 Signature postale effacée");
              }
            });
          }
        }

        // 3. Surveillance des ouvertures de modales pour peupler l'email
        function setupModalEmailPopulation() {
          // Fonction pour remplir l'email à l'ouverture des modales (async)
          async function handleModalOpen() {
            setTimeout(async () => {
              const success = await populateEmailFromFormData();
              if (!success) {
                console.log("🔍 Tentative de récupération alternative...");
                // Tentative alternative avec un délai
                setTimeout(() => populateEmailFromFormData(), 500);
              }
            }, 100);
          }

          // Observer l'ouverture de la modale PDF
          const pdfModal = document.getElementById("pdf-modal");
          if (pdfModal) {
            const observer = new MutationObserver(function (mutations) {
              mutations.forEach(function (mutation) {
                if (
                  mutation.type === "attributes" &&
                  mutation.attributeName === "class"
                ) {
                  if (pdfModal.classList.contains("active")) {
                    console.log("📂 Modale PDF ouverte");
                    handleModalOpen();
                  }
                }
              });
            });
            observer.observe(pdfModal, { attributes: true });
          }

          // Observer l'ouverture de la modale postale
          const postalModal = document.getElementById("postal-modal");
          if (postalModal) {
            const observer = new MutationObserver(function (mutations) {
              mutations.forEach(function (mutation) {
                if (
                  mutation.type === "attributes" &&
                  mutation.attributeName === "class"
                ) {
                  if (postalModal.classList.contains("active")) {
                    console.log("📂 Modale postale ouverte");
                    handleModalOpen();
                  }
                }
              });
            });
            observer.observe(postalModal, { attributes: true });
          }

          // Également écouter les clics sur les boutons pour forcer le remplissage
          const pdfBtn = document.getElementById("btn-premium-pdf");
          const postalBtn = document.getElementById("btn-postal");

          if (pdfBtn) {
            pdfBtn.addEventListener("click", () => {
              setTimeout(() => handleModalOpen(), 200);
            });
          }

          if (postalBtn) {
            postalBtn.addEventListener("click", () => {
              setTimeout(() => handleModalOpen(), 200);
            });
          }
        }

        // Initialisation avec debug
        console.log("🚀 Initialisation des corrections...");

        // Tentative immédiate de remplissage (async)
        populateEmailFromFormData();

        // Configuration des fonctionnalités
        setupClearButtons();
        setupModalEmailPopulation();

        // Debug complet du sessionStorage au chargement
        console.log("📊 Analyse du sessionStorage:");
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          const value = sessionStorage.getItem(key);
          console.log(`  ${key}:`, value);
        }

        console.log("✅ Corrections signature et email initialisées");
      });
    </script>
  </body>
</html>
