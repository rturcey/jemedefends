<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mise en demeure - Je me défends</title>
    <style>
      /* ====== FONTS LOCALES ====== */
      @font-face {
        font-family: "Inter";
        src: url("/static/fonts/inter-regular.woff2") format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Inter";
        src: url("/static/fonts/inter-bold.woff2") format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }

      /* ====== VARIABLES CSS ====== */
      :root {
        --brand-blue: #3b82f6;
        --brand-dark: #1e40af;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-muted: #374151;
        --border-light: #e5e7eb;
        --bg-light: #f8fafc;
        --bg-blue-light: #eff6ff;
      }

      /* ====== BASE ====== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      @page {
        size: A4;
        margin: 0;
      }
      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        font-size: 9pt;
        line-height: 1.3;
        color: var(--text-primary);
        background: #fff;
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      /* ====== LAYOUT PRINCIPAL ====== */
      .pdf-page {
        width: 210mm;
        height: 297mm;
        max-height: 297mm;
        padding: 15mm 20mm 20mm 20mm;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      /* ====== HEADER AVEC LOGO ====== */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 10mm;
        padding-bottom: 5mm;
        border-bottom: 1.5px solid var(--brand-blue);
      }
      .brand-logo img {
        height: 48px;
        width: auto;
        display: block;
      }
      .doc-date {
        font-weight: 600;
        font-size: 9pt;
        color: var(--text-muted);
        text-align: right;
        margin-bottom: 8px;
      }

      /* ====== ADRESSES ====== */
      .addresses {
        display: flex;
        justify-content: space-between;
        gap: 8mm;
        margin-bottom: 6mm;
        overflow-wrap: break-word;
      }
      .address-block .label {
        font-weight: 700;
        font-size: 8pt;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--brand-blue);
        flex: 1;
      }
      .address-block.to {
        justify-self: end;
        text-align: left;
      }
      .address-content {
        font-size: 9pt;
        line-height: 1.3;
        color: var(--text-primary);
      }
      .address-content strong {
        font-weight: 700;
      }

      /* ====== OBJET ====== */
      .subject {
        background: linear-gradient(
          135deg,
          var(--brand-blue),
          var(--brand-dark)
        );
        color: #fff;
        padding: 8px 16px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        text-align: center;
      }
      .subject-title {
        font-weight: 700;
        font-size: 11pt;
        margin-bottom: 2px;
      }
      .subject-ref {
        font-size: 9pt;
        opacity: 0.9;
        font-weight: 400;
      }

      /* ====== CONTENU ====== */
      .content {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        max-height: calc(297mm - 120mm);
      }
      .overflow-protection {
        max-height: calc(297mm - 100mm);
        overflow: hidden;
      }
      .greeting {
        font-size: 10pt;
        margin: 6mm 0;
        font-weight: 500;
      }
      .paragraph {
        margin-bottom: 5mm;
        text-align: justify;
        line-height: 1.3;
        font-size: 10pt;
        overflow-wrap: break-word;
      }
      .paragraph.description {
        max-height: 25mm;
        overflow: hidden;
        position: relative;
        word-break: break-all;
        hyphens: auto;
      }
      .highlight {
        font-weight: 700;
        color: var(--brand-dark);
      }
      .product_price,
      .date-ref {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum";
        font-weight: 600;
      }

      /* ====== ENCADRÉS ====== */
      .legal-box {
        background: linear-gradient(135deg, var(--bg-blue-light), #e0f2fe);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-left: 4px solid var(--brand-blue);
        padding: 10pt 12pt;
        margin: 8mm 0;
        line-height: 1.3;
      }
      .legal-box strong {
        font-weight: 700;
        color: var(--brand-dark);
      }

      .warning {
        background: linear-gradient(135deg, #fef3c7, #fed7aa);
        border-left: 4px solid #f59e0b;
        padding: 10pt 12pt;
        margin: 8mm 0;
        line-height: 1.3;
      }
      .warning strong {
        color: #92400e;
        font-weight: 700;
      }

      /* ====== NEW: encadré “charge de la preuve” compact ====== */
      .legal-note {
        background: #f8fafc;
        border: 1px solid var(--border-light);
        border-left: 4px solid var(--brand-blue);
        padding: 8pt 10pt;
        margin: 6mm 0;
        line-height: 1.3;
        font-size: 9.5pt;
      }
      .legal-note em {
        font-style: normal;
        color: var(--text-secondary);
      }

      /* ====== SIGNATURE ====== */
      .signature-section {
        margin-top: auto;
        padding-top: 5mm;
        display: flex;
        justify-content: flex-end;
        page-break-inside: avoid;
      }
      .signature-block {
        text-align: center;
        max-width: 70mm;
      }
      .signature-name {
        font-weight: 700;
        font-size: 11pt;
        color: var(--text-primary);
        margin-bottom: 4mm;
      }
      .signature-box {
        padding: 8px;
        background: #fff;
        min-height: 25mm;
        display: flex;
        align-items: right;
        justify-content: right;
      }
      .signature-box img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .signature-placeholder {
        color: var(--text-muted);
        font-style: italic;
        font-size: 9pt;
      }

      /* ====== PRINT OPTIMIZATIONS ====== */
      @media print {
        .signature-section {
          margin-top: 10mm;
        }
        .signature-box img {
          max-height: 20mm;
        }
      }
    </style>

    {% if show_watermark %}
      <style>
        .watermark-overlay {
          position: fixed;
          inset: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1000;
        }
        .watermark-overlay::before {
          content: "{{ watermark_text|default('APERÇU NON VALABLE') }}";
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-15deg);
          font-weight: 700;
          letter-spacing: 0.2em;
          font-size: 40px;
          color: rgba(239, 68, 68, 0.4);
          white-space: nowrap;
          font-family: "Arial", sans-serif;
        }
        .watermark-overlay::after {
          content: "";
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100' viewBox='0 0 200 100'%3E%3Ctext x='100' y='50' font-family='Arial' font-size='16' font-weight='400' letter-spacing='0.3em' fill='%23ef4444' fill-opacity='0.12' text-anchor='middle' dominant-baseline='middle' transform='rotate(-15 100 50)'%3EAPER%C3%87U%3C/text%3E%3C/svg%3E");
          background-repeat: repeat;
          background-size: 200px 100px;
          transform: rotate(-15deg);
        }
        @media print {
          .watermark-overlay::before {
            font-size: 35px;
            color: rgba(239, 68, 68, 0.5);
          }
        }
      </style>
    {% endif %}
  </head>
  <body>
    <div class="pdf-page">
      {% if show_watermark %}
        <div class="watermark-overlay"></div>
      {% endif %}

      <!-- HEADER -->
      <header class="header">
        <div class="brand-logo">
          <img
            src="{{ logo_src }}"
            alt="Je me défends - Mes droits, tout simplement"
          />
        </div>
        <div class="doc-date">Le {{ current_date }}</div>
      </header>

      <!-- ADRESSES -->
      <section class="addresses">
        <div class="address-block">
          <div class="label">Expéditeur</div>
          <div class="address-content">
            <strong>{{ letter.buyer_name }}</strong><br />
            {{ letter.buyer_address | replace('\n','<br />') | safe }}
          </div>
        </div>
        <div class="address-block to">
          <div class="label">Destinataire</div>
          <div class="address-content">
            À l'attention de <strong>{{ letter.seller_name }}</strong><br />
            {{ letter.seller_address | replace('\n','<br />') | safe }}
          </div>
        </div>
      </section>

      <!-- OBJET -->
      <div class="subject">
        <div class="subject-title">
          Mise en demeure de mise en conformité d’un bien non conforme
        </div>
        <div class="subject-ref">
          Réf. légales : Articles L.217-3 et <u>L.217-7</u> du Code de la
          consommation
        </div>
      </div>

      <!-- CONTENU -->
      <main class="content overflow-protection">
        <div class="greeting">Madame, Monsieur,</div>

        <div class="paragraph">
          Le <span class="date-ref">{{ purchase_date_formatted }}</span>, j'ai
          acheté auprès de votre société le produit suivant :
          <span class="highlight">{{ letter.product_name }}</span>
          {% if letter.order_reference %}
            <em
              >(commande n°<span class="product_price"
                >{{ letter.order_reference }}</span
              >)</em
            >
          {% endif %},
          pour un montant de
          <span class="highlight product_price"
            >{{ product_price_formatted }}</span
          >.
        </div>

        <div class="paragraph description">
          Or, ce bien présente aujourd'hui un défaut de conformité caractérisé
          par :
          <span class="highlight">{{ letter.defect_description }}</span>.
        </div>

        <div class="legal-box">
          <strong>Base légale :</strong> Conformément aux articles L.217-3 et
          suivants du Code de la consommation, je vous mets en demeure de
          procéder, <strong>sans frais</strong>, à la réparation ou au
          remplacement de ce bien dans un délai de
          <strong>14 jours calendaires</strong> à compter de la réception de ce
          courrier.
        </div>

        <!-- NEW: Charge de la preuve (art. L.217-7) -->
        {%
          set _limit = presumption_limit_months | default( (12 if letter.used
          else 24) )
        %}
        {% if presumption_active is defined %}
          {%
            set _presumption
            = presumption_active
          %}
        {% else %}
          {% set _presumption = true %}
        {% endif %}
        {% if _presumption %}
          <div class="legal-note">
            <strong>Charge de la preuve - art. L.217-7 :</strong>
            le défaut étant apparu dans le délai de
            <strong>{{ _limit }} mois</strong> à compter de la délivrance, il
            est <em>présumé exister</em> au jour de celle-ci. En conséquence,
            <strong>il vous appartient d’apporter la preuve contraire</strong>.
          </div>
        {% endif %}

        <div class="warning">
          <strong>⚠️ Conséquences en cas de non-réponse :</strong><br />
          Faute de réponse satisfaisante dans ce délai, je me réserve le droit
          d'engager toute action utile, notamment auprès de la DGCCRF,
          d'associations de consommateurs ou par voie judiciaire.
        </div>

        <div class="paragraph">
          Dans l'attente de votre retour rapide, je vous prie d'agréer, Madame,
          Monsieur, l'expression de mes salutations distinguées.
        </div>

        <!-- SIGNATURE -->
        <div class="signature-section">
          <div class="signature-block">
            <div class="signature-name">{{ letter.buyer_name }}</div>
            <div class="signature-box">
              {% if signature_data_url %}
                <img
                  src="{{ signature_data_url }}"
                  alt="Signature de {{ letter.buyer_name }}"
                />
              {% else %}
                <div class="signature-placeholder">
                  {% if is_preview %}Signature requise{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
