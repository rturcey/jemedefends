<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mise en demeure - Je me défends</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root{
            --blue-600:#2563EB; --blue-700:#1D4ED8;
            --blue-50:#EFF6FF;  --blue-100:#DBEAFE;
            --blue-accent-50:#E0F2FE; --bluegray-500:#64748B;
            --slate-900:#0F172A; --slate-800:#1F2937; --slate-700:#374151; --slate-600:#475569; --slate-200:#E2E8F0;
            --orange-600:#EA580C;
        }

        *{margin:0;padding:0;box-sizing:border-box;}
        @page{size:A4;margin:0;}

        body{
            font-family:'Inter',system-ui,sans-serif; color:var(--slate-900);
            font-size:9.6pt; line-height:1.45; background:#fff; -webkit-font-smoothing:antialiased;
        }

        .page{
            position:relative; width:210mm; height:297mm;
            padding:11mm 20mm 9mm; display:flex; flex-direction:column;
        }

        /* Ruban bleu gauche */
        .page::before{
            content:''; position:absolute; left:0; top:0; width:3mm; height:100%; background:var(--blue-600);
        }

        /* === ADRESSES — fiable, sans chevauchement, pas de vide inutile === */
        .addresses{
            display:flex;
            justify-content: space-between;
            margin-bottom:4.5mm;
        }
        .address{
            display:flex;
            flex-direction:column;
            gap:1mm;
        }
        .address-name{
            font-size:10.3pt;
            font-weight:800;
            margin-bottom:1mm;
            color:var(--blue-700);
        }
        .address-line{
            color:var(--slate-800); font-size:9pt; line-height:1.35;
            white-space:normal;
            word-break:normal; overflow-wrap:anywhere; hyphens:auto;
        }

        /* Sujet centré + filet */
        .subject{position:relative;text-align:center;margin:4mm 0 3mm;padding-bottom:3mm;}
        .subject::after{content:'';position:absolute;left:50%;transform:translateX(-50%);bottom:0;width:48mm;height:1.5px;background:var(--blue-accent-50);}
        .subject-title{font-weight:800;color:var(--blue-700);font-size:16pt;text-transform:uppercase;letter-spacing:0.5px;}
        .subject-sub{color:var(--bluegray-500);font-size:8.5pt;margin-top:2px;}

        .body{flex:1;}
        .body p{margin:6px 0;text-align:justify;}
        .body strong{font-weight:800;color:var(--slate-900);}

        /* Défaut : pas de fond/bordure */
        .defect{display:flex;gap:8px;align-items:flex-start;text-align:justify;margin:6px 0;}
        .defect-icon{width:6px;height:6px;border-radius:50%;background:var(--orange-600);margin-top:5px;flex-shrink:0;}
        .defect-text{font-size:8.9pt;color:#9A3412;}

        /* Titres de section */
        .h3{
            margin:7px 0 4px; padding-bottom:3px; font-weight:900; font-size:10.2pt; color:var(--blue-700);
            border-bottom:1.3px solid var(--blue-accent-50); position:relative;
        }
        .h3::after{content:'';position:absolute;left:0;bottom:-1.3px;width:28px;height:1.3px;background:var(--blue-600);}

        /* Bloc légal (conteneur) sans fond/bordure */
        .legal{margin:5px 0; text-align:justify;}
        .legal-title{font-weight:900;color:var(--blue-700);margin-bottom:4px;font-size:9.5pt;}

        /* Articles en deux colonnes robustes */
        .legal-articles{column-count:2; column-gap:10px;}
        .legal-article{
            break-inside:avoid; -webkit-column-break-inside:avoid; page-break-inside:avoid;
            font-size:8.4pt; line-height:1.45; color:var(--slate-800);
            margin:0 0 6px 0; padding:0; background:none; border:none;
        }
        .legal-article strong{color:var(--blue-700);font-weight:800;}

        /* Signature */
        .sign-wrap{margin-top:7mm;display:flex;justify-content:flex-end;clear:both;break-inside:avoid;page-break-inside:avoid;}
        .sign-box{min-width:160px;text-align:center;}
        .sign-label{font-size:7.1pt;color:var(--slate-700);}
        .sign-name{margin:5px 0 7px;font-weight:900;color:var(--slate-900);font-size:9.9pt;}
        .sign-area{min-height:46px;display:grid;place-items:center;background:#fff;border-top:1px solid var(--blue-accent-50);}
        .signature-img{max-width:100%;max-height:44px;object-fit:contain;}
        .signature-placeholder{color:var(--slate-600);font-style:italic;font-size:8.5pt;}

        /* Pied de page */
        .footer{position:sticky;bottom:0;left:0;align-self:flex-start;margin-top:auto;padding-top:4mm;display:flex;gap:8px;align-items:center;}
        .footer .brand{display:flex;align-items:center;gap:8px;}
        .footer .logo{width:31px;height:31px;}
        .footer .logo img{width:31px;height:32px;}
        .footer .brand-text h1{font-size:11pt;font-weight:800;color:var(--blue-700);letter-spacing:-0.02em;line-height:1;}
        .footer .brand-text p{font-size:7pt;color:var(--slate-600);font-weight:600;margin-top:1px;letter-spacing:0.01em;}

        /* Filigrane logo très léger */
        .wm-logo{
            position:fixed; top:50%; left:50%;
            transform:translate(-50%,-50%);
            opacity:0.05; width:70%; max-width:520px; z-index:0; pointer-events:none; filter:grayscale(100%);
        }

        /* Filigrane d'aperçu */
        .wm-preview {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            z-index: 5;
            font-weight: 800;
            color: var(--blue-700);
            font-size: 36pt;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.3;
            white-space: nowrap;
        }

        @media print{
            body{-webkit-print-color-adjust:exact;}
            .footer{position:static;margin-top:8mm;padding-top:0;}
            .page{page-break-after:avoid;}
        }
    </style>
</head>
<body>
{% if logo_src %}
    <img src="{{ logo_src }}" alt="Je me défends" class="wm-logo">
{% else %}
    <img src="frontend/public/images/logo_jemedefends.png" alt="Je me défends" class="wm-logo">
{% endif %}

{% if add_watermark %}
    <div class="wm-preview">
        APERÇU DE VOTRE LETTRE
    </div>
{% endif %}

<div class="page">
    <!-- Addresses -->
    <section class="addresses">
        <div class="address">
            <div class="address-name">{{ letter.buyer_name }}</div>
            <div class="address-line">{{ letter.buyer_address.line1 | replace('\n',' ') | replace('\r',' ') }}</div>
            {% if letter.buyer_address.line2 %}<div class="address-line">{{ letter.buyer_address.line2 | replace('\n',' ') | replace('\r',' ') }}</div>{% endif %}
            <div class="address-line">{{ letter.buyer_address.postal_code }} {{ letter.buyer_address.city }}</div>
            <div class="address-line">{{ letter.buyer_address.country }}</div>
            {% if letter.buyer_email %}<div class="address-line">{{ letter.buyer_email }}</div>{% endif %}
            {% if letter.buyer_phone %}<div class="address-line">{{ letter.buyer_phone }}</div>{% endif %}
        </div>

        <div class="address">
            <div class="address-name">{{ letter.seller_name }}</div>
            <div class="address-line">{{ letter.seller_address.line1 | replace('\n',' ') | replace('\r',' ') }}</div>
            {% if letter.seller_address.line2 %}<div class="address-line">{{ letter.seller_address.line2 | replace('\n',' ') | replace('\r',' ') }}</div>{% endif %}
            <div class="address-line">{{ letter.seller_address.postal_code }} {{ letter.seller_address.city }}</div>
            <div class="address-line">{{ letter.seller_address.country }}</div>
            {% if letter.seller_email %}<div class="address-line">{{ letter.seller_email }}</div>{% endif %}
            {% if letter.seller_phone %}<div class="address-line">{{ letter.seller_phone }}</div>{% endif %}
        </div>
    </section>

    <!-- Subject -->
    <section class="subject">
        <div class="subject-title">Mise en demeure</div>
        <div class="subject-sub">
            {% if letter.digital %}
                Application de la garantie légale de conformité (contenus et services numériques)
            {% else %}
                Application de la garantie légale de conformité
            {% endif %}
        </div>
    </section>

    <!-- Body -->
    <section class="body">
        <p>Madame, Monsieur,</p>

        <p>
            {% set pn = letter.product_name or '' %}
            {% set pn_l = pn|lower %}
            {% if letter.digital %}
                {# Service numérique : formulation dédiée #}
                J’ai souscrit le <strong>{{ purchase_date_formatted }}</strong> <strong>{{ pn }}</strong>
            {% else %}
                {# Bien : “faire l’acquisition de …” avec préposition correcte #}
                {% if pn_l.startswith("l’") or pn_l.startswith("l'") %}
                    {% set prep = "de " %}
                {% elif pn_l.startswith("des ") %}
                    {% set prep = "" %}
                {% elif pn_l.startswith("un ") or pn_l.startswith("une ") %}
                    {% set prep = "d’" %}
                {% else %}
                    {% set prep = "de " %}
                {% endif %}
                J’ai fait l’acquisition le <strong>{{ purchase_date_formatted }}</strong> {{ prep }}<strong>{{ pn }}</strong>
            {% endif %}
            au prix de <strong>{{ product_price_formatted }}</strong>
            {% if letter.order_reference %}, référence <strong>{{ letter.order_reference }}</strong>.{% else %}.{% endif %}
        </p>

        <div class="defect">
            <div class="defect-icon"></div>
            <div class="defect-text"><strong>Défaut constaté :</strong> {{ letter.defect_description }}</div>
        </div>

        <h3 class="h3">Fondements juridiques</h3>

        {% if letter.digital %}
            <p>En application des <strong>articles L.224-25-13 à L.224-25-32 du Code de la consommation</strong>, vous êtes tenu de fournir un service numérique conforme au contrat et répondez des défauts de conformité existant lors de la fourniture ou apparaissant pendant la période de fourniture.</p>
        {% else %}
            <p>En application des <strong>articles L.217-3 à L.217-14 du Code de la consommation</strong>, vous êtes tenu de livrer un bien conforme au contrat et répondez des défauts de conformité existant lors de la délivrance.</p>
        {% endif %}

        <div class="legal">
            <div class="legal-title">Articles de référence</div>
            <div class="legal-articles">
                {% if letter.digital %}
                    <div class="legal-article">
                        <strong>L.224-25-16 :</strong> Le défaut de conformité apparu dans les douze mois suivant la fourniture est présumé exister à cette date, sauf preuve contraire.
                    </div>
                    <div class="legal-article">
                        <strong>L.224-25-18 :</strong> Mise en conformité <em>sans frais</em>, <em>sans retard injustifié</em> et <em>sans inconvénient majeur</em> pour le consommateur.
                    </div>
                    <div class="legal-article">
                        <strong>L.224-25-20 à L.224-25-22 :</strong> À défaut de mise en conformité, réduction du prix proportionnelle ou résolution du contrat, selon les cas.
                    </div>
                    <div class="legal-article">
                        <strong>L.224-25-25 à L.224-25-26 :</strong> Mises à jour nécessaires au maintien de la conformité ; droit de refuser une mise à jour non nécessaire ayant un effet négatif.
                    </div>
                    <div class="legal-article">
                        <strong>L.224-25-32 :</strong> Dispositions d’ordre public.
                    </div>
                {% else %}
                    <div class="legal-article">
                        <strong>L.217-7 :</strong>
                        Le défaut de conformité apparaissant dans un délai de
                        {% if letter.used %}douze mois (bien d’occasion){% else %}vingt-quatre mois{% endif %}
                        à compter de la délivrance du bien est présumé exister au jour de la délivrance.
                    </div>
                    <div class="legal-article">
                        <strong>L.217-9 :</strong>
                        Le consommateur choisit entre réparation et remplacement, sauf si l’option choisie entraîne un coût manifestement disproportionné.
                    </div>
                    <div class="legal-article">
                        <strong>L.217-10 :</strong>
                        La mise en conformité intervient dans un délai raisonnable n’excédant pas <strong>30 jours</strong> à compter de la demande et sans inconvénient majeur.
                    </div>
                    <div class="legal-article">
                        <strong>L.217-11 :</strong>
                        La mise en conformité a lieu sans aucun coût pour le consommateur (pièces, main-d’œuvre, diagnostic, enlèvement, transport, réexpédition).
                    </div>
                {% endif %}
            </div>
        </div>

        <h3 class="h3">Mes demandes</h3>
        <p>
            Par la présente, je vous mets en demeure de procéder à la
            <strong>mise en conformité gratuite</strong>
            {% if letter.digital %}du service{% else %}du bien{% endif %}
            selon les modalités légales suivantes&nbsp;:
            {% if letter.digital %}
                <strong>mise en conformité</strong> du service défaillant,
                <em>sans retard injustifié</em>,
                sans inconvénient majeur, et <strong>sans aucun frais</strong> à ma charge
                (incluant diagnostic, assistance et intervention).
            {% else %}
                {% if letter.remedy_preference.value == 'replacement' %}
                    <strong>remplacement</strong>
                {% elif letter.remedy_preference.value == 'termination' %}
                    <strong>résolution</strong>
                {% else %}
                    <strong>réparation</strong>
                {% endif %}
                du produit défaillant,
                dans un délai maximum de <strong>30&nbsp;jours</strong>,
                sans inconvénient majeur, et <strong>sans aucun frais</strong> à ma charge
                (incluant diagnostic, enlèvement, transport et réexpédition).
            {% endif %}
        </p>

        <h3 class="h3">Délai et conséquences</h3>
        <p>
            À défaut de votre part de rendre le
            {% if letter.digital %}service{% else %}bien{% endif %}
            conforme dans les conditions ci-dessus, je solliciterai une <strong>réduction du prix</strong> ou la <strong>résolution du {% if letter.digital %}contrat{% else %}contrat de vente{% endif %}</strong>, conformément aux textes applicables.
        </p>
        <p>Sans réponse satisfaisante sous <strong>quinze (15) jours</strong> à compter de la réception de ce courrier, j’engagerai les suites utiles.</p>
        <p>Dans l’attente de votre retour rapide, je vous prie d’agréer, Madame, Monsieur, l’expression de mes salutations distinguées.</p>
    </section>

    <!-- Signature -->
    <section class="sign-wrap">
        <div class="sign-box">
            <div class="sign-label">Fait le {{ current_date }} à {{ letter.buyer_address.city }}</div>
            <div class="sign-name">{{ letter.buyer_name }}</div>
            <div class="sign-area">
                {% if signature_data_url %}
                    <img src="{{ signature_data_url }}" alt="Signature" class="signature-img">
                {% else %}
                    <div class="signature-placeholder">Signature manuscrite</div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="brand">
            <div class="logo">
                {% if logo_src %}
                    <img src="{{ logo_src }}" alt="Logo Je me défends">
                {% else %}
                    <img src="frontend/public/images/logo_jemedefends.png" alt="Logo Je me défends">
                {% endif %}
            </div>
            <div class="brand-text">
                <h1>Je me défends</h1>
                <p>La loi au service des consommateurs</p>
            </div>
        </div>
    </footer>
</div>
</body>
</html>
